[gcode_macro PRINT_END]
gcode:
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400 # Wait for buffer to clear
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    
    TURN_OFF_HEATERS
    M107 # Turn off fan
    M84 # Disable steppers

    RESTORE_GCODE_STATE NAME=STATE_PRINT_END